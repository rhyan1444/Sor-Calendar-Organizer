<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard ‚Äî Schedule System (CSV)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <!-- HEADER -->
  <header class="bg-white border-b shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <h1 class="text-xl font-semibold">Admin Dashboard</h1>
      <div class="flex items-center gap-3">
        <button id="addScheduleBtn" class="px-3 py-1.5 rounded-xl bg-blue-600 text-white w-full sm:w-auto">+ Add Schedule</button>
        <a href="login.html" id="logoutBtn" class="px-3 py-1.5 rounded-xl bg-black text-white w-full sm:w-auto text-center">Log out</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- CALENDAR -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Calendar</h2>
      <div id="calendar" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 gap-2 text-center"></div>
      <div class="flex flex-wrap gap-2 mt-3 text-sm">
        <span class="px-2 py-1 bg-green-200 rounded">Done</span>
        <span class="px-2 py-1 bg-red-200 rounded">Canceled</span>
        <span class="px-2 py-1 bg-yellow-200 rounded">Rescheduled</span>
        <span class="px-2 py-1 bg-blue-200 rounded">Pending</span>
        <span class="px-2 py-1 bg-gray-200 rounded">Free Day</span>
      </div>
    </section>

    <!-- TABLE (responsive to cards on small screens) -->
    <section class="bg-white rounded-2xl shadow overflow-hidden">
      <div class="p-4 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
        <h2 class="text-lg font-semibold">Schedules</h2>
        <input id="search" class="border rounded-xl px-3 py-2 w-full md:w-80" placeholder="Search...">
      </div>

      <!-- Desktop Table -->
      <div class="hidden md:block overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="p-3 text-left">#</th>
              <th class="p-3 text-left">Event</th>
              <th class="p-3 text-left">Date</th>
              <th class="p-3 text-left">Time</th>
              <th class="p-3 text-left">Place</th>
              <th class="p-3 text-left">Driver</th>
              <th class="p-3 text-left">Team</th>
              <th class="p-3 text-left">Status</th>
              <th class="p-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <!-- Mobile Cards -->
      <div id="cardContainer" class="block md:hidden p-4 space-y-4"></div>
    </section>
  </main>

  <!-- MODAL -->
  <div id="modal" class="fixed inset-0 hidden bg-black bg-opacity-50 flex items-center justify-center px-4">
    <div class="bg-white rounded-2xl shadow-lg w-full max-w-md p-6">
      <h2 id="modalTitle" class="text-xl font-semibold mb-4">Add Schedule</h2>
      <form id="scheduleForm" class="space-y-4">
        <input type="hidden" id="scheduleId">
        <div>
          <label class="block text-sm font-medium">Event</label>
          <input id="event" required class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium">Date</label>
          <input id="date" type="date" required class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium">Time</label>
          <input id="time" type="time" required class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium">Place</label>
          <input id="place" required class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium">Driver</label>
          <input id="driver" class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium">Team</label>
          <input id="team" class="w-full border rounded-xl px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium">Status</label>
          <select id="status" class="w-full border rounded-xl px-3 py-2">
            <option value="Pending">Pending</option>
            <option value="Done">Done</option>
            <option value="Canceled">Canceled</option>
            <option value="Rescheduled">Rescheduled</option>
          </select>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" id="cancelBtn" class="px-3 py-2 rounded-xl border">Cancel</button>
          <button class="px-3 py-2 rounded-xl bg-blue-600 text-white">Save</button>
        </div>
      </form>
    </div>
  </div>

<script>
const CSV_KEY='schedules_csv', SESSION_KEY='currentUser';
const HEADERS=['id','event','date','time','place','driver','team','status'];

function requireAdmin(){
  const u = JSON.parse(localStorage.getItem(SESSION_KEY) || 'null');
  if(!u){ window.location.href='login.html'; return; }
  if(u.role!=='admin'){ window.location.href='staff-dashboard.html'; }
}
requireAdmin();

// CSV helpers
function parseCsvLine(line){
  const out=[], re=/(?:^|,)(?:"([^"]*(?:""[^"]*)*)"|([^",]*))/g;
  line.replace(re,(m,g1,g2)=>{ out.push((g1||g2||'').replace(/""/g,'"')); });
  return out;
}
function csvToArray(csv){
  const lines = csv.trim()?csv.trim().split(/\r?\n/):[];
  if(!lines.length) return [];
  const header = lines[0].split(',');
  return lines.slice(1).map(line=>{
    const cells=parseCsvLine(line);
    const obj={}; header.forEach((h,i)=>obj[h]=cells[i]??'');
    return obj;
  });
}
function arrayToCsv(arr){
  return [HEADERS.join(',')].concat(arr.map(o=>HEADERS.map(h=>`"${(o[h]||'').replace(/"/g,'""')}"`).join(','))).join('\n');
}
function getSchedules(){ let csv=localStorage.getItem(CSV_KEY); return csv?csvToArray(csv):[]; }
function saveSchedules(data){ localStorage.setItem(CSV_KEY,arrayToCsv(data)); }

// UI elements
const tbody=document.getElementById('tbody');
const cardContainer=document.getElementById('cardContainer');
const modal=document.getElementById('modal');
const scheduleForm=document.getElementById('scheduleForm');
const scheduleId=document.getElementById('scheduleId');
const search=document.getElementById('search');

function statusBadge(status){
  let colors={
    'Done':'bg-green-200 text-green-800',
    'Canceled':'bg-red-200 text-red-800',
    'Rescheduled':'bg-yellow-200 text-yellow-800',
    'Pending':'bg-blue-200 text-blue-800'
  };
  return `<span class="px-2 py-1 rounded ${colors[status]||'bg-gray-200'}">${status}</span>`;
}

// Format time to AM/PM
function formatTime(t){
  if(!t) return '';
  let [h,m]=t.split(':');
  h=parseInt(h,10);
  let ampm=h>=12?'PM':'AM';
  h=h%12||12;
  return `${h}:${m} ${ampm}`;
}

function render(filter=''){
  const rows=getSchedules();
  const q=filter.toLowerCase();
  const filtered=rows.filter(r=>{
    const hay=[r.event,r.place,r.driver,r.team,r.status].join(' ').toLowerCase();
    return hay.includes(q);
  });

  // Desktop Table
  tbody.innerHTML='';
  filtered.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.className=i%2?'bg-gray-50':'bg-white';
    tr.innerHTML=`
      <td class="p-3">${i+1}</td>
      <td class="p-3">${r.event}</td>
      <td class="p-3">${r.date}</td>
      <td class="p-3">${formatTime(r.time)}</td>
      <td class="p-3">${r.place}</td>
      <td class="p-3">${r.driver}</td>
      <td class="p-3">${r.team}</td>
      <td class="p-3">${statusBadge(r.status)}</td>
      <td class="p-3">
        <button onclick="editSchedule('${r.id}')" class="text-blue-600">Edit</button>
        <button onclick="deleteSchedule('${r.id}')" class="text-red-600 ml-2">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });

  // Mobile Cards
  cardContainer.innerHTML='';
  filtered.forEach((r,i)=>{
    const div=document.createElement('div');
    div.className="border rounded-xl p-3 shadow-sm";
    div.innerHTML=`
      <div class="font-semibold">${r.event}</div>
      <div class="text-sm text-gray-600">${r.date} ‚Ä¢ ${formatTime(r.time)}</div>
      <div class="text-sm">üìç ${r.place}</div>
      <div class="text-sm">üöó ${r.driver || '-'}</div>
      <div class="text-sm">üë• ${r.team || '-'}</div>
      <div class="mt-2">${statusBadge(r.status)}</div>
      <div class="flex gap-3 mt-2">
        <button onclick="editSchedule('${r.id}')" class="text-blue-600 text-sm">Edit</button>
        <button onclick="deleteSchedule('${r.id}')" class="text-red-600 text-sm">Delete</button>
      </div>`;
    cardContainer.appendChild(div);
  });

  renderCalendar(rows);
}

// Calendar
function renderCalendar(schedules){
  const cal=document.getElementById('calendar');
  cal.innerHTML='';
  let now=new Date();
  let year=now.getFullYear(), month=now.getMonth();
  let firstDay=new Date(year,month,1).getDay();
  let daysInMonth=new Date(year,month+1,0).getDate();

  let statusByDate={};
  schedules.forEach(s=>{ if(s.date){ statusByDate[s.date]=s.status; } });

  for(let i=0;i<firstDay;i++){ cal.innerHTML+=`<div></div>`; }
  for(let d=1;d<=daysInMonth;d++){
    let dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    let status=statusByDate[dateStr]||'Free';
    let colors={
      'Done':'bg-green-200',
      'Canceled':'bg-red-200',
      'Rescheduled':'bg-yellow-200',
      'Pending':'bg-blue-200',
      'Free':'bg-gray-100'
    };
    cal.innerHTML+=`<div class="p-2 rounded ${colors[status]}">${d}</div>`;
  }
}

// CRUD
function openModal(edit=false){ modal.classList.remove('hidden'); document.getElementById('modalTitle').textContent=edit?'Edit Schedule':'Add Schedule'; }
document.getElementById('addScheduleBtn').addEventListener('click',()=>{ scheduleForm.reset(); scheduleId.value=''; openModal(false); });
document.getElementById('cancelBtn').addEventListener('click',()=>modal.classList.add('hidden'));
scheduleForm.addEventListener('submit',(e)=>{
  e.preventDefault();
  let rows=getSchedules();
  let id=scheduleId.value||Date.now().toString();
  let newObj={
    id,
    event:document.getElementById('event').value,
    date:document.getElementById('date').value,
    time:document.getElementById('time').value,
    place:document.getElementById('place').value,
    driver:document.getElementById('driver').value,
    team:document.getElementById('team').value,
    status:document.getElementById('status').value
  };
  if(scheduleId.value){ rows=rows.map(r=>r.id===id?newObj:r); } else { rows.push(newObj); }
  saveSchedules(rows);
  modal.classList.add('hidden');
  render(search.value);
});
function editSchedule(id){
  let rows=getSchedules();
  let r=rows.find(x=>x.id===id);
  if(!r)return;
  scheduleId.value=r.id;
  document.getElementById('event').value=r.event;
  document.getElementById('date').value=r.date;
  document.getElementById('time').value=r.time;
  document.getElementById('place').value=r.place;
  document.getElementById('driver').value=r.driver;
  document.getElementById('team').value=r.team;
  document.getElementById('status').value=r.status;
  openModal(true);
}
function deleteSchedule(id){
  if(!confirm('Delete this schedule?')) return;
  let rows=getSchedules().filter(r=>r.id!==id);
  saveSchedules(rows);
  render(search.value);
}

// Search & Logout
search.addEventListener('input',()=>render(search.value));
document.getElementById('logoutBtn').addEventListener('click',()=>localStorage.removeItem(SESSION_KEY));

render();
</script>
</body>
</html>
